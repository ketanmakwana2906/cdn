# Use Red Hat UBI 8.10
FROM redhat/ubi8:8.10

# Disable SSL verification only for local testing (remove in production)
RUN echo "sslverify=0" >> /etc/dnf/dnf.conf 

# Update system packages
RUN yum -y update && yum clean all

# Set working directory
WORKDIR /app

# Copy application code
COPY . .

# Install Node.js directly
RUN dnf install -y nodejs

# Install 'n' for Node.js version management
RUN npm install -g n && n 20.13.1

# Set Node.js PATH manually (required for `n` to work)
ENV PATH="/root/n/bin:$PATH"

# Install Python 3.12 (Requires CodeReady Builder)
RUN yum config-manager --set-enabled codeready-builder-for-rhel-8-x86_64-rpms && \
    yum install -y python3.12 && yum clean all

# Install Chromium (Required for Puppeteer)
RUN yum install -y epel-release && \
    yum install -y chromium && yum clean all

# Set Puppeteer to use system Chromium
ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser
RUN PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true npm i --legacy-peer-deps

# Expose application port
EXPOSE 4000

# Start application
CMD ["node", "server.js"]
