from bs4 import BeautifulSoup
from django.utils.deprecation import MiddlewareMixin

class CSPNonceMiddleware(MiddlewareMixin):
    def process_response(self, request, response):
        # Only modify HTML responses
        content_type = response.get("Content-Type", "")
        if "text/html" in content_type:
            # Parse the HTML content using BeautifulSoup
            soup = BeautifulSoup(response.content, "html.parser")
            fixed_nonce = "123456789"  # Fixed nonce value
            
            # Add nonce to every <script> tag if not present
            for script in soup.find_all("script"):
                if not script.get("nonce"):
                    script["nonce"] = fixed_nonce
            
            # Update the response content with the modified HTML
            response.content = str(soup)

        return response
