# adminutils/forms.py
from django import forms

class SQLRunForm(forms.Form):
    query = forms.CharField(
        widget=forms.Textarea(attrs={'rows': 10, 'cols': 100}),
        label="Enter SQL Query (you can paste multiple separated by semicolon)",
    )

# adminutils/admin.py
from django.contrib import admin
from django.urls import path
from django.shortcuts import render
from django.db import connection
from django.contrib.admin.views.decorators import staff_member_required
from .forms import SQLRunForm

@staff_member_required
def run_sql_view(request):
    result_html = ""
    if request.method == 'POST':
        form = SQLRunForm(request.POST)
        if form.is_valid():
            queries = form.cleaned_data['query']
            queries_list = [q.strip() for q in queries.split(';') if q.strip()]
            try:
                with connection.cursor() as cursor:
                    for q in queries_list:
                        cursor.execute(q)
                    if cursor.description:
                        columns = [col[0] for col in cursor.description]
                        rows = cursor.fetchall()
                        result_html += "<table border='1'><tr>{}</tr>".format(
                            ''.join(f'<th>{c}</th>' for c in columns)
                        )
                        for row in rows:
                            result_html += "<tr>{}</tr>".format(
                                ''.join(f'<td>{v}</td>' for v in row)
                            )
                        result_html += "</table>"
                    else:
                        result_html += "<p>All queries executed successfully.</p>"
            except Exception as e:
                result_html = f"<p style='color:red;'>Error: {e}</p>"
    else:
        form = SQLRunForm()

    return render(request, 'admin/run_sql.html', {
        'form': form,
        'result': result_html
    })

# Register the view in admin
class CustomAdminSite(admin.AdminSite):
    def get_urls(self):
        urls = super().get_urls()
        custom_urls = [
            path('run-sql/', self.admin_view(run_sql_view), name='run-sql'),
        ]
        return custom_urls + urls

admin.site = CustomAdminSite()

{% extends "admin/base_site.html" %}
{% block content %}
  <h2>Run Raw SQL</h2>
  <form method="post">{% csrf_token %}
    {{ form.as_p }}
    <button type="submit" class="default">Run</button>
  </form>
  <br/>
  {{ result|safe }}
{% endblock %}
