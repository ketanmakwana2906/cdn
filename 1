# admin.py
from django.contrib import admin
from django.urls import path
from django.http import JsonResponse, HttpResponseForbidden
from django.template.response import TemplateResponse
from django.utils.html import format_html
from django.contrib.auth.decorators import permission_required
from django.utils.decorators import method_decorator

from .models import PayoutPayment

class PayoutDashboardAdminView(admin.ModelAdmin):
    change_list_template = "admin/payout_dashboard.html"

    def get_urls(self):
        urls = super().get_urls()
        custom_urls = [
            path("dashboard/", self.admin_site.admin_view(self.dashboard_view), name="payout-dashboard"),
        ]
        return custom_urls + urls

    def dashboard_view(self, request):
        if not request.user.has_perms(["yourapp.view_payoutpayment", "yourapp.change_payoutpayment"]):
            return HttpResponseForbidden("You do not have permission to view this dashboard")

        # Fake function to simulate API hit, replace with your real API calls
        def booking_det(request):
            return {"pnr_number": "1234567890", "train_number": "12345", "amount": 2500.50}

        def refund_det(request, tm_booking_id):
            return {"refund_amount": 1500.00, "status": "processed"}

        tm_booking_id = request.GET.get('tm_booking_id')
        if not tm_booking_id:
            return TemplateResponse(request, "admin/payout_dashboard.html", {"error": "Missing tm_booking_id"})

        data = {
            "booking_details": booking_det(request),
            "refund_details": refund_det(request, tm_booking_id),
        }

        return TemplateResponse(request, "admin/payout_dashboard.html", {"data": data})


admin.site.register(PayoutPayment, PayoutDashboardAdminView)

# admin/payout_dashboard.html (create this template)
# ---------------------------------------------
# {% extends "admin/base_site.html" %}
# {% block content %}
# <h2>Payout Dashboard</h2>
# {% if error %}
#     <p style="color: red">{{ error }}</p>
# {% else %}
#     <h3>Booking Details</h3>
#     <pre>{{ data.booking_details|safe }}</pre>
#     <h3>Refund Details</h3>
#     <pre>{{ data.refund_details|safe }}</pre>
# {% endif %}
# {% endblock %}
