SELECT 
    DATE_FORMAT(b.created_at, '%Y-%m') AS month, 
    SUM(b.total_amount) AS total_collected_cancelled,
    SUM(r.refunded_amount) AS total_refunded,
    ROUND(
        (SUM(r.refunded_amount) / NULLIF(SUM(b.total_amount), 0)) * 100, 
        2
    ) AS refund_percentage
FROM irctc_booking b
LEFT JOIN (
    -- sum successful refunds per booking
    SELECT booking_id, SUM(amount_refunded) AS refunded_amount
    FROM irctc_gateway_refund
    WHERE amount_refunded IS NOT NULL
    GROUP BY booking_id
) r ON b.booking_id = r.booking_id
WHERE b.status = 'CANCELLED'
GROUP BY DATE_FORMAT(b.created_at, '%Y-%m')
ORDER BY month;
