import re
import uuid
from bs4 import BeautifulSoup
from django.http import HttpResponse

class CSPMiddleware(object):
    def process_response(self, request, response):
        if "text/html" in response.get('Content-Type', ''):
            nonce = str(uuid.uuid4()).replace("-", "")  # Generate a unique nonce
            
            # Construct CSP header using format()
            csp_header = (
                "default-src 'self'; "
                "script-src https://www.trainman.in/ https://uat.trainman.in/ https://blog.trainman.in/ "
                "https://blog-uat.trainman.in/ https://www.namniart.in/ https://aksdev.trainman.in/ "
                "https://cdnjs.cloudflare.com/ https://www.google-analytics.com http://connect.facebook.net/ "
                "http://ajax.googleapis.com/ https://www.googletagmanager.com/ http://pagead2.googlesyndication.com/ "
                "https://s.go-mpulse.net/ 'unsafe-inline' 'strict-dynamic' 'nonce-{nonce}'; "
                "style-src https://www.trainman.in/ https://uat.trainman.in/ https://blog.trainman.in/ "
                "https://blog-uat.trainman.in/ https://www.namniart.in/ https://aksdev.trainman.in/ 'self' "
                "https://fonts.googleapis.com/ https://maxcdn.bootstrapcdn.com/ 'unsafe-inline'; "
                "frame-ancestors 'self'; "
                "img-src https://www.trainman.in/ https://uat.trainman.in/ https://blog.trainman.in/ "
                "https://blog-uat.trainman.in/ https://www.namniart.in/ https://aksdev.trainman.in/ 'self'; "
                "connect-src https://www.trainman.in/ https://uat.trainman.in/ https://blog.trainman.in/ "
                "https://blog-uat.trainman.in/ https://www.namniart.in/ https://aksdev.trainman.in/ 'self' "
                "https://www.google-analytics.com/ https://c.go-mpulse.net/ https://s.go-mpulse.net/ "
                "https://*.akstat.io/; "
                "object-src 'none'; "
                "font-src https://www.trainman.in/ https://uat.trainman.in/ https://blog.trainman.in/ "
                "https://blog-uat.trainman.in/ https://www.namniart.in/ https://aksdev.trainman.in/ 'self' "
                "https://fonts.gstatic.com/ https://maxcdn.bootstrapcdn.com/; "
                "form-action 'self'; "
                "base-uri 'self';"
            ).format(nonce=nonce)

            response["Content-Security-Policy"] = csp_header

            # Modify HTML response to add nonce attributes to inline scripts
            soup = BeautifulSoup(response.content, "html.parser")

            for script in soup.find_all("script"):
                if not script.has_attr("src"):  # Only modify inline scripts
                    script["nonce"] = nonce

            response.content = str(soup)
        
        return response


Refused to load the script 'http://ajax.googleapis.com/ajax/libs/jquery/3.5.0/jquery.min.js' because it violates the following Content Security Policy directive: "script-src https://www.trainman.in/ https://uat.trainman.in/ https://blog.trainman.in/ https://blog-uat.trainman.in/ https://www.namniart.in/ https://aksdev.trainman.in/ https://cdnjs.cloudflare.com/ https://www.google-analytics.com http://connect.facebook.net/ http://ajax.googleapis.com/ https://www.googletagmanager.com/ http://pagead2.googlesyndication.com/ https://s.go-mpulse.net/ 'unsafe-inline' 'strict-dynamic' 'nonce-7951a10dbb6a4789bc3510c9748a0f92'". Note that 'strict-dynamic' is present, so host-based allowlisting is disabled. Note that 'script-src-elem' was not explicitly set, so 'script-src' is used as a fallback.

