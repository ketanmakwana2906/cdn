from bs4 import BeautifulSoup
from django.utils.deprecation import MiddlewareMixin

class CSPNonceMiddleware(MiddlewareMixin):
    def process_response(self, request, response):
        # Only modify HTML responses
        content_type = response.get("Content-Type", "")
        if "text/html" in content_type:
            # Parse the HTML content using BeautifulSoup
            soup = BeautifulSoup(response.content, "html.parser")
            fixed_nonce = "123456789"  # Fixed nonce value
            # Loop through every <script> tag and add the nonce if it's not already present
            for script in soup.find_all("script"):
                if not script.get("nonce"):
                    script["nonce"] = fixed_nonce
            # Update the response content with the modified HTML
            response.content = str(soup)

        # Build the Content-Security-Policy header string
        csp_header = (
            "script-src https://www.trainman.in/ 'unsafe-inline' 'strict-dynamic' 'nonce-123456789'; "
            "style-src https://www.trainman.in/ https://uat.trainman.in/ https://blog.trainman.in/ "
                "https://blog-uat.trainman.in/ https://www.namniart.in/ https://aksdev.trainman.in/ 'self' "
                "https://fonts.googleapis.com/ https://maxcdn.bootstrapcdn.com/ 'unsafe-inline'; "
            "frame-ancestors 'self'; "
            "default-src 'self'; "
            "img-src https://www.trainman.in/ https://uat.trainman.in/ https://blog.trainman.in/ "
                "https://blog-uat.trainman.in/ https://www.namniart.in/ https://aksdev.trainman.in/ 'self'; "
            "connect-src https://www.trainman.in/ https://uat.trainman.in/ https://blog.trainman.in/ "
                "https://blog-uat.trainman.in/ https://www.namniart.in/ https://aksdev.trainman.in/ 'self' "
                "https://www.google-analytics.com/ https://c.go-mpulse.net/ https://s.go-mpulse.net/ "
                "https://*.akstat.io/; "
            "object-src 'none'; "
            "font-src https://www.trainman.in/ https://uat.trainman.in/ https://blog.trainman.in/ "
                "https://blog-uat.trainman.in/ https://www.namniart.in/ https://aksdev.trainman.in/ 'self' "
                "https://fonts.gstatic.com/ https://maxcdn.bootstrapcdn.com/; "
            "form-action 'self'; "
            "base-uri 'self'; "
            "require-trusted-types-for 'script'"
        )

        # Set the CSP header on the response
        response["Content-Security-Policy"] = csp_header
        return response
